<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Log Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Log Viewer for managing and filtering log data"
    />
    <meta name="keywords" content="log, viewer, filter, data, log management" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <h1>Log Viewer</h1>
    <button id="toggleFilterType">Toggle Filter Type</button>
    <form id="filterForm">
      <div id="singleFilter" class="filterSection">
        <div class="filterRow">
          <select class="filterField" name="filterField">
            <option value="level">Level</option>
            <option value="message">Message</option>
            <option value="resourceId">Resource ID</option>
            <option value="timestamp">TimeStamp</option>
            <option value="traceId">Trace ID</option>
            <option value="spanId">Span ID</option>
            <option value="commit">Commit</option>
            <optgroup label="MetaData">
              <option value="metadata.parentResourceId">
                Parent Resource ID
              </option>
            </optgroup>
          </select>
          <input class="filterValue" type="text" name="filterValue" />
        </div>
      </div>
      <div id="multipleFilter">
        <label for="level">Level:</label>
        <input
          type="text"
          id="level"
          name="level"
          class="filterValue"
          placeholder="Enter Level"
        /><br /><br />

        <label for="message">Message:</label>
        <input
          type="text"
          id="message"
          name="message"
          class="filterValue"
          placeholder="Enter Message"
        /><br /><br />

        <label for="resourceId">Resource ID:</label>
        <input
          type="text"
          id="resourceId"
          name="resourceId"
          class="filterValue"
          placeholder="Enter Resource ID"
        /><br /><br />

        <label for="timestamp">Timestamp:</label>
        <input
          type="text"
          id="timestamp"
          name="timestamp"
          class="filterValue"
          placeholder="Enter Timestamp"
        /><br /><br />

        <label for="traceId">Trace ID:</label>
        <input
          type="text"
          id="traceId"
          name="traceId"
          class="filterValue"
          placeholder="Enter Trace ID"
        /><br /><br />

        <label for="spanId">Span ID:</label>
        <input
          type="text"
          id="spanId"
          name="spanId"
          class="filterValue"
          placeholder="Enter Span ID"
        /><br /><br />

        <label for="commit">Commit:</label>
        <input
          type="text"
          id="commit"
          name="commit"
          class="filterValue"
          placeholder="Enter Commit"
        /><br /><br />

        <label for="parentResourceId">Parent Resource ID:</label>
        <input
          type="text"
          id="parentResourceId"
          name="metadata.   parentResourceId"
          class="filterValue"
          placeholder="Enter Parent Resource ID"
        /><br /><br />
      </div>
      <button type="submit">Filter</button>
    </form>

    <table id="logTable">
      <thead>
        <tr>
          <th>Level</th>
          <th>Message</th>
          <th>Resource ID</th>
          <th>TimeStamp</th>
          <th>Trace ID</th>
          <th>Span ID</th>
          <th>Commit</th>
          <th>MetaData</th>
        </tr>
      </thead>
      <tbody id="logData">
        <!-- Table body will be populated with filtered data -->
      </tbody>
    </table>

    <script>
      // JavaScript code for handling form submission, fetching data, and pagination
      const filterForm = document.getElementById("filterForm");
      const logDataElement = document.getElementById("logData");
      const prevPageButton = document.getElementById("prevPage");
      const nextPageButton = document.getElementById("nextPage");
      const currentPageElement = document.getElementById("currentPage");
      let mode = "single_filter";

      filterForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(filterForm);
        const filteredData = await fetchFilteredData(formData);
        renderData(filteredData);
      });

      async function fetchFilteredData(formData) {
        const filteredFormData = Array.from(formData.entries()).reduce(
          (acc, [key, value]) => {
            if (value !== "") {
              acc.append(key, value);
            }
            return acc;
          },
          new FormData()
        );
        try {
          let response;
          if (mode === "single_filter") {
            const queryString = new URLSearchParams(
              filteredFormData
            ).toString(); // Convert form data to query string
            response = await fetch(`/logs/filter?${queryString}`); // Construct URL with query parameters
          } else {
            filteredFormData.delete("filterField");
            filteredFormData.delete("filterValue");
            const body = Object.fromEntries(filteredFormData);
            options = {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(body),
            };
            response = await fetch(`/logs/filter`, options);
          }
          if (!response.ok) {
            throw new Error("Network response was not ok.");
          }
          const data = await response.json();
          return data?.result;
        } catch (error) {
          console.error("Error fetching data:", error.message);
          return [];
        }
      }

      function renderData(data) {
        logDataElement.innerHTML = "";
        data.forEach((log) => {
          const row = document.createElement("tr");
          row.innerHTML = `
          <td>${log.level}</td>
          <td>${log.message}</td>
          <td>${log.resourceId}</td>
          <td>${log.timestamp}</td>
          <td>${log.traceId}</td>
          <td>${log.spanId}</td>
          <td>${log.commit}</td>
          <td>${JSON.stringify(log.metadata)}</td>
          <!-- Render other fields -->
        `;
          logDataElement.appendChild(row);
        });
      }

      const toggleButton = document.getElementById("toggleFilterType");
      const singleFilter = document.getElementById("singleFilter");
      const multipleFilter = document.getElementById("multipleFilter");

      toggleButton.addEventListener("click", () => {
        if (singleFilter.style.display === "none") {
          singleFilter.style.display = "block";
          multipleFilter.style.display = "none";
          mode = "single_filter";
        } else {
          singleFilter.style.display = "none";
          multipleFilter.style.display = "block";
          mode = "multiple_filter";
        }
      });
    </script>
  </body>
</html>
